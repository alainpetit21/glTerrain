#include <memory.h>
#include "MathFP.h"
int Sin[256],Cos[256];

void InitTables()
{
	Sin[0]		=0		;Cos[0]		=1024	;
	Sin[1]		=25		;Cos[1]		=1024	;
	Sin[2]		=50		;Cos[2]		=1023	;
	Sin[3]		=75		;Cos[3]		=1021	;
	Sin[4]		=100	;Cos[4]		=1019	;
	Sin[5]		=125	;Cos[5]		=1016	;
	Sin[6]		=150	;Cos[6]		=1013	;
	Sin[7]		=175	;Cos[7]		=1009	;
	Sin[8]		=200	;Cos[8]		=1004	;
	Sin[9]		=224	;Cos[9]		=999	;
	Sin[10]		=249	;Cos[10]	=993	;
	Sin[11]		=273	;Cos[11]	=987	;
	Sin[12]		=297	;Cos[12]	=980	;
	Sin[13]		=321	;Cos[13]	=972	;
	Sin[14]		=345	;Cos[14]	=964	;
	Sin[15]		=369	;Cos[15]	=955	;
	Sin[16]		=392	;Cos[16]	=946	;
	Sin[17]		=415	;Cos[17]	=936	;
	Sin[18]		=438	;Cos[18]	=926	;
	Sin[19]		=460	;Cos[19]	=915	;
	Sin[20]		=483	;Cos[20]	=903	;
	Sin[21]		=505	;Cos[21]	=891	;
	Sin[22]		=526	;Cos[22]	=878	;
	Sin[23]		=548	;Cos[23]	=865	;
	Sin[24]		=569	;Cos[24]	=851	;
	Sin[25]		=590	;Cos[25]	=837	;
	Sin[26]		=610	;Cos[26]	=822	;
	Sin[27]		=630	;Cos[27]	=807	;
	Sin[28]		=650	;Cos[28]	=792	;
	Sin[29]		=669	;Cos[29]	=775	;
	Sin[30]		=688	;Cos[30]	=759	;
	Sin[31]		=706	;Cos[31]	=742	;
	Sin[32]		=724	;Cos[32]	=724	;
	Sin[33]		=742	;Cos[33]	=706	;
	Sin[34]		=759	;Cos[34]	=688	;
	Sin[35]		=775	;Cos[35]	=669	;
	Sin[36]		=792	;Cos[36]	=650	;
	Sin[37]		=807	;Cos[37]	=630	;
	Sin[38]		=822	;Cos[38]	=610	;
	Sin[39]		=837	;Cos[39]	=590	;
	Sin[40]		=851	;Cos[40]	=569	;
	Sin[41]		=865	;Cos[41]	=548	;
	Sin[42]		=878	;Cos[42]	=526	;
	Sin[43]		=891	;Cos[43]	=505	;
	Sin[44]		=903	;Cos[44]	=483	;
	Sin[45]		=915	;Cos[45]	=460	;
	Sin[46]		=926	;Cos[46]	=438	;
	Sin[47]		=936	;Cos[47]	=415	;
	Sin[48]		=946	;Cos[48]	=392	;
	Sin[49]		=955	;Cos[49]	=369	;
	Sin[50]		=964	;Cos[50]	=345	;
	Sin[51]		=972	;Cos[51]	=321	;
	Sin[52]		=980	;Cos[52]	=297	;
	Sin[53]		=987	;Cos[53]	=273	;
	Sin[54]		=993	;Cos[54]	=249	;
	Sin[55]		=999	;Cos[55]	=224	;
	Sin[56]		=1004	;Cos[56]	=200	;
	Sin[57]		=1009	;Cos[57]	=175	;
	Sin[58]		=1013	;Cos[58]	=150	;
	Sin[59]		=1016	;Cos[59]	=125	;
	Sin[60]		=1019	;Cos[60]	=100	;
	Sin[61]		=1021	;Cos[61]	=75		;
	Sin[62]		=1023	;Cos[62]	=50		;
	Sin[63]		=1024	;Cos[63]	=25		;
	Sin[64]		=1024	;Cos[64]	=0		;
	Sin[65]		=1024	;Cos[65]	=-24	;
	Sin[66]		=1023	;Cos[66]	=-49	;
	Sin[67]		=1021	;Cos[67]	=-74	;
	Sin[68]		=1019	;Cos[68]	=-99	;
	Sin[69]		=1016	;Cos[69]	=-124	;
	Sin[70]		=1013	;Cos[70]	=-149	;
	Sin[71]		=1009	;Cos[71]	=-174	;
	Sin[72]		=1004	;Cos[72]	=-199	;
	Sin[73]		=999	;Cos[73]	=-223	;
	Sin[74]		=993	;Cos[74]	=-248	;
	Sin[75]		=987	;Cos[75]	=-272	;
	Sin[76]		=980	;Cos[76]	=-296	;
	Sin[77]		=972	;Cos[77]	=-320	;
	Sin[78]		=964	;Cos[78]	=-344	;
	Sin[79]		=955	;Cos[79]	=-368	;
	Sin[80]		=946	;Cos[80]	=-391	;
	Sin[81]		=936	;Cos[81]	=-414	;
	Sin[82]		=926	;Cos[82]	=-437	;
	Sin[83]		=915	;Cos[83]	=-459	;
	Sin[84]		=903	;Cos[84]	=-482	;
	Sin[85]		=891	;Cos[85]	=-504	;
	Sin[86]		=878	;Cos[86]	=-525	;
	Sin[87]		=865	;Cos[87]	=-547	;
	Sin[88]		=851	;Cos[88]	=-568	;
	Sin[89]		=837	;Cos[89]	=-589	;
	Sin[90]		=822	;Cos[90]	=-609	;
	Sin[91]		=807	;Cos[91]	=-629	;
	Sin[92]		=792	;Cos[92]	=-649	;
	Sin[93]		=775	;Cos[93]	=-668	;
	Sin[94]		=759	;Cos[94]	=-687	;
	Sin[95]		=742	;Cos[95]	=-705	;
	Sin[96]		=724	;Cos[96]	=-723	;
	Sin[97]		=706	;Cos[97]	=-741	;
	Sin[98]		=688	;Cos[98]	=-758	;
	Sin[99]		=669	;Cos[99]	=-774	;
	Sin[100]	=650	;Cos[100]	=-791	;
	Sin[101]	=630	;Cos[101]	=-806	;
	Sin[102]	=610	;Cos[102]	=-821	;
	Sin[103]	=590	;Cos[103]	=-836	;
	Sin[104]	=569	;Cos[104]	=-850	;
	Sin[105]	=548	;Cos[105]	=-864	;
	Sin[106]	=526	;Cos[106]	=-877	;
	Sin[107]	=505	;Cos[107]	=-890	;
	Sin[108]	=483	;Cos[108]	=-902	;
	Sin[109]	=460	;Cos[109]	=-914	;
	Sin[110]	=438	;Cos[110]	=-925	;
	Sin[111]	=415	;Cos[111]	=-935	;
	Sin[112]	=392	;Cos[112]	=-945	;
	Sin[113]	=369	;Cos[113]	=-954	;
	Sin[114]	=345	;Cos[114]	=-963	;
	Sin[115]	=321	;Cos[115]	=-971	;
	Sin[116]	=297	;Cos[116]	=-979	;
	Sin[117]	=273	;Cos[117]	=-986	;
	Sin[118]	=249	;Cos[118]	=-992	;
	Sin[119]	=224	;Cos[119]	=-998	;
	Sin[120]	=200	;Cos[120]	=-1003;
	Sin[121]	=175	;Cos[121]	=-1008;
	Sin[122]	=150	;Cos[122]	=-1012;
	Sin[123]	=125	;Cos[123]	=-1015;
	Sin[124]	=100	;Cos[124]	=-1018;
	Sin[125]	=75		;Cos[125]	=-1020;
	Sin[126]	=50		;Cos[126]	=-1022;
	Sin[127]	=25		;Cos[127]	=-1023;
	Sin[128]	=0		;Cos[128]	=-1023;
	Sin[129]	=-24	;Cos[129]	=-1023;
	Sin[130]	=-49	;Cos[130]	=-1022;
	Sin[131]	=-74	;Cos[131]	=-1020;
	Sin[132]	=-99	;Cos[132]	=-1018;
	Sin[133]	=-124	;Cos[133]	=-1015;
	Sin[134]	=-149	;Cos[134]	=-1012;
	Sin[135]	=-174	;Cos[135]	=-1008;
	Sin[136]	=-199	;Cos[136]	=-1003;
	Sin[137]	=-223	;Cos[137]	=-998	;
	Sin[138]	=-248	;Cos[138]	=-992	;
	Sin[139]	=-272	;Cos[139]	=-986	;
	Sin[140]	=-296	;Cos[140]	=-979	;
	Sin[141]	=-320	;Cos[141]	=-971	;
	Sin[142]	=-344	;Cos[142]	=-963	;
	Sin[143]	=-368	;Cos[143]	=-954	;
	Sin[144]	=-391	;Cos[144]	=-945	;
	Sin[145]	=-414	;Cos[145]	=-935	;
	Sin[146]	=-437	;Cos[146]	=-925	;
	Sin[147]	=-459	;Cos[147]	=-914	;
	Sin[148]	=-482	;Cos[148]	=-902	;
	Sin[149]	=-504	;Cos[149]	=-890	;
	Sin[150]	=-525	;Cos[150]	=-877	;
	Sin[151]	=-547	;Cos[151]	=-864	;
	Sin[152]	=-568	;Cos[152]	=-850	;
	Sin[153]	=-589	;Cos[153]	=-836	;
	Sin[154]	=-609	;Cos[154]	=-821	;
	Sin[155]	=-629	;Cos[155]	=-806	;
	Sin[156]	=-649	;Cos[156]	=-791	;
	Sin[157]	=-668	;Cos[157]	=-774	;
	Sin[158]	=-687	;Cos[158]	=-758	;
	Sin[159]	=-705	;Cos[159]	=-741	;
	Sin[160]	=-723	;Cos[160]	=-723	;
	Sin[161]	=-741	;Cos[161]	=-705	;
	Sin[162]	=-758	;Cos[162]	=-687	;
	Sin[163]	=-774	;Cos[163]	=-668	;
	Sin[164]	=-791	;Cos[164]	=-649	;
	Sin[165]	=-806	;Cos[165]	=-629	;
	Sin[166]	=-821	;Cos[166]	=-609	;
	Sin[167]	=-836	;Cos[167]	=-589	;
	Sin[168]	=-850	;Cos[168]	=-568	;
	Sin[169]	=-864	;Cos[169]	=-547	;
	Sin[170]	=-877	;Cos[170]	=-525	;
	Sin[171]	=-890	;Cos[171]	=-504	;
	Sin[172]	=-902	;Cos[172]	=-482	;
	Sin[173]	=-914	;Cos[173]	=-459	;
	Sin[174]	=-925	;Cos[174]	=-437	;
	Sin[175]	=-935	;Cos[175]	=-414	;
	Sin[176]	=-945	;Cos[176]	=-391	;
	Sin[177]	=-954	;Cos[177]	=-368	;
	Sin[178]	=-963	;Cos[178]	=-344	;
	Sin[179]	=-971	;Cos[179]	=-320	;
	Sin[180]	=-979	;Cos[180]	=-296	;
	Sin[181]	=-986	;Cos[181]	=-272	;
	Sin[182]	=-992	;Cos[182]	=-248	;
	Sin[183]	=-998	;Cos[183]	=-223	;
	Sin[184]	=-1003;Cos[184]	=-199	;
	Sin[185]	=-1008;Cos[185]	=-174	;
	Sin[186]	=-1012;Cos[186]	=-149	;
	Sin[187]	=-1015;Cos[187]	=-124	;
	Sin[188]	=-1018;Cos[188]	=-99	;
	Sin[189]	=-1020;Cos[189]	=-74	;
	Sin[190]	=-1022;Cos[190]	=-49	;
	Sin[191]	=-1023;Cos[191]	=-24	;
	Sin[192]	=-1023;Cos[192]	=0		;
	Sin[193]	=-1023;Cos[193]	=25		;
	Sin[194]	=-1022;Cos[194]	=50		;
	Sin[195]	=-1020;Cos[195]	=75		;
	Sin[196]	=-1018;Cos[196]	=100	;
	Sin[197]	=-1015;Cos[197]	=125	;
	Sin[198]	=-1012;Cos[198]	=150	;
	Sin[199]	=-1008;Cos[199]	=175	;
	Sin[200]	=-1003;Cos[200]	=200	;
	Sin[201]	=-998	;Cos[201]	=224	;
	Sin[202]	=-992	;Cos[202]	=249	;
	Sin[203]	=-986	;Cos[203]	=273	;
	Sin[204]	=-979	;Cos[204]	=297	;
	Sin[205]	=-971	;Cos[205]	=321	;
	Sin[206]	=-963	;Cos[206]	=345	;
	Sin[207]	=-954	;Cos[207]	=369	;
	Sin[208]	=-945	;Cos[208]	=392	;
	Sin[209]	=-935	;Cos[209]	=415	;
	Sin[210]	=-925	;Cos[210]	=438	;
	Sin[211]	=-914	;Cos[211]	=460	;
	Sin[212]	=-902	;Cos[212]	=483	;
	Sin[213]	=-890	;Cos[213]	=505	;
	Sin[214]	=-877	;Cos[214]	=526	;
	Sin[215]	=-864	;Cos[215]	=548	;
	Sin[216]	=-850	;Cos[216]	=569	;
	Sin[217]	=-836	;Cos[217]	=590	;
	Sin[218]	=-821	;Cos[218]	=610	;
	Sin[219]	=-806	;Cos[219]	=630	;
	Sin[220]	=-791	;Cos[220]	=650	;
	Sin[221]	=-774	;Cos[221]	=669	;
	Sin[222]	=-758	;Cos[222]	=688	;
	Sin[223]	=-741	;Cos[223]	=706	;
	Sin[224]	=-723	;Cos[224]	=724	;
	Sin[225]	=-705	;Cos[225]	=742	;
	Sin[226]	=-687	;Cos[226]	=759	;
	Sin[227]	=-668	;Cos[227]	=775	;
	Sin[228]	=-649	;Cos[228]	=792	;
	Sin[229]	=-629	;Cos[229]	=807	;
	Sin[230]	=-609	;Cos[230]	=822	;
	Sin[231]	=-589	;Cos[231]	=837	;
	Sin[232]	=-568	;Cos[232]	=851	;
	Sin[233]	=-547	;Cos[233]	=865	;
	Sin[234]	=-525	;Cos[234]	=878	;
	Sin[235]	=-504	;Cos[235]	=891	;
	Sin[236]	=-482	;Cos[236]	=903	;
	Sin[237]	=-459	;Cos[237]	=915	;
	Sin[238]	=-437	;Cos[238]	=926	;
	Sin[239]	=-414	;Cos[239]	=936	;
	Sin[240]	=-391	;Cos[240]	=946	;
	Sin[241]	=-368	;Cos[241]	=955	;
	Sin[242]	=-344	;Cos[242]	=964	;
	Sin[243]	=-320	;Cos[243]	=972	;
	Sin[244]	=-296	;Cos[244]	=980	;
	Sin[245]	=-272	;Cos[245]	=987	;
	Sin[246]	=-248	;Cos[246]	=993	;
	Sin[247]	=-223	;Cos[247]	=999	;
	Sin[248]	=-199	;Cos[248]	=1004	;
	Sin[249]	=-174	;Cos[249]	=1009	;
	Sin[250]	=-149	;Cos[250]	=1013	;
	Sin[251]	=-124	;Cos[251]	=1016	;
	Sin[252]	=-99	;Cos[252]	=1019	;
	Sin[253]	=-74	;Cos[253]	=1021	;
	Sin[254]	=-49	;Cos[254]	=1023	;
	Sin[255]	=-24	;Cos[255]	=1024	;
}

void CMatrix::Identity()
{
	memset(l, 0x0, sizeof(int)*16);
	l[0] = l[5] = l[10] = l[15] = FP_ONE;
}

void CMatrix::Rotatex( int a_X )
{
	int sinx = Sin[a_X];
	int cosx = Cos[a_X];
	Identity();
	l[5] = cosx;
	l[6] = sinx;
	l[9] = -sinx;
	l[10] = cosx;
}

void CMatrix::Rotatey( int a_Y )
{
	int siny = Sin[a_Y];
	int cosy = Cos[a_Y];
	Identity();
	l[0] = cosy;
	l[2] = -siny;
	l[8] = siny;
	l[10] = cosy;
}

void CMatrix::Rotatez( int a_Z )
{
	int sinz = Sin[a_Z];
	int cosz = Cos[a_Z];
	Identity();
	l[0] = cosz;
	l[1] = sinz;
	l[4] = -sinz;
	l[5] = cosz;
}

void CMatrix::Translate( int a_X, int a_Y, int a_Z )
{
	l[3] += a_X;
	l[7] += a_Y;
	l[11]+= a_Z;
}

void CMatrix::Concat( const CMatrix& a_M2)
{
	CMatrix res;
	for ( int col = 0; col < 4; col++ )
		for ( int row = 0; row < 4; row++ )
			res.l[row * 4 + col] = 
				FPMUL(l[row * 4], a_M2.l[col] ) +
				FPMUL(l[row * 4 + 1], a_M2.l[col + 4] ) +
				FPMUL(l[row * 4 + 2], a_M2.l[col + 8] );

	memcpy(l, res.l, sizeof(int)*16);
}

void CMatrix::Rotate( int a_RX, int a_RY, int a_RZ )
{	
	CMatrix tempmat;
	tempmat.Rotatex( a_RX );
	this->Rotatey( a_RY );
	this->Concat( tempmat );
	tempmat.Rotatez( a_RZ );
	this->Concat( tempmat );
}

int*
CMatrix::Getx(int* p_vec)
{
	p_vec[0]= l[0];
	p_vec[1]= l[4];
	p_vec[2]= l[8];
	return p_vec;
}

int*
CMatrix::Gety(int* p_vec)
{
	p_vec[0]= l[1];
	p_vec[1]= l[5];
	p_vec[2]= l[9];
	return p_vec;
}

int*
CMatrix::Getz(int* p_vec)
{
	p_vec[0]= l[2];
	p_vec[1]= l[6];
	p_vec[2]= l[10];
	return p_vec;
}

